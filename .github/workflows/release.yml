name: Create Release

# GitHub Releasesä½œæˆã«å¿…è¦ãªæ¨©é™ã‚’ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãƒ¬ãƒ™ãƒ«ã§è¨­å®š
permissions:
  contents: write
  actions: read
  pull-requests: read

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      tag_name:
        description: "Release tag name (e.g., v1.0.0)"
        required: true
        type: string
      prerelease:
        description: "Mark as prerelease"
        required: false
        type: boolean
        default: false

jobs:
  release:
    runs-on: ubuntu-latest
    # ã‚¸ãƒ§ãƒ–ãŒç¢ºå®Ÿã«å®Ÿè¡Œã•ã‚Œã‚‹ã‚ˆã†ã«æ¡ä»¶ã‚’æ˜Žç¢ºã«è¨­å®š
    if: always()

    # GitHub Releasesä½œæˆã«å¿…è¦ãªæ¨©é™ã‚’è¿½åŠ 
    permissions:
      contents: write
      actions: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Verify GitHub token permissions
        run: |
          echo "Checking GitHub token permissions..."
          gh api user --jq '.login' || echo "Token validation failed"
          gh api repos/${{ github.repository }} --jq '.permissions' || echo "Repository permissions check failed"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Debug workflow trigger
        run: |
          echo "Event name: ${{ github.event_name }}"
          echo "Ref: ${{ github.ref }}"
          echo "SHA: ${{ github.sha }}"
          echo "Repository: ${{ github.repository }}"

      - name: Set tag name
        id: set_tag
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "tag_name=${{ github.event.inputs.tag_name }}" >> $GITHUB_OUTPUT
            echo "prerelease=${{ github.event.inputs.prerelease }}" >> $GITHUB_OUTPUT
          else
            echo "tag_name=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
            echo "prerelease=false" >> $GITHUB_OUTPUT
          fi

          # ãƒ‡ãƒãƒƒã‚°å‡ºåŠ›
          echo "Set tag name: ${GITHUB_REF#refs/tags/}"

      - name: Create tag (if workflow_dispatch)
        if: github.event_name == 'workflow_dispatch'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag ${{ steps.set_tag.outputs.tag_name }}
          git push origin ${{ steps.set_tag.outputs.tag_name }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Wait for build workflow
        run: |
          echo "Waiting for build workflow to complete..."
          sleep 30

      - name: Check build workflow status
        id: build_status
        run: |
          # ã‚¿ã‚°ã¾ãŸã¯ã‚³ãƒŸãƒƒãƒˆSHAã§æœ€æ–°ã®ãƒ“ãƒ«ãƒ‰ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®Ÿè¡Œã‚’å–å¾—
          echo "Looking for build workflow runs..."

          # è¤‡æ•°ã®æ¡ä»¶ã§æ¤œç´¢
          RUN_ID=$(gh api repos/${{ github.repository }}/actions/workflows/build-executables.yml/runs \
            --jq ".workflow_runs[] | select(.head_sha == \"${{ github.sha }}\" or .head_branch == \"${{ steps.set_tag.outputs.tag_name }}\" or .event == \"push\") | .id" | head -1)

          if [ -z "$RUN_ID" ] || [ "$RUN_ID" == "null" ]; then
            echo "No build workflow found for SHA: ${{ github.sha }}"
            echo "Checking recent runs..."
            gh api repos/${{ github.repository }}/actions/workflows/build-executables.yml/runs --jq '.workflow_runs[0:3] | .[] | {id: .id, sha: .head_sha, branch: .head_branch, event: .event, status: .status}'
            exit 1
          fi

          echo "build_run_id=$RUN_ID" >> $GITHUB_OUTPUT
          echo "Found build run: $RUN_ID"

          # Wait for workflow to complete
          for i in {1..30}; do
            STATUS=$(gh api repos/${{ github.repository }}/actions/runs/$RUN_ID --jq '.status')
            CONCLUSION=$(gh api repos/${{ github.repository }}/actions/runs/$RUN_ID --jq '.conclusion')

            echo "Build status: $STATUS, conclusion: $CONCLUSION"

            if [ "$STATUS" == "completed" ]; then
              if [ "$CONCLUSION" == "success" ]; then
                echo "Build completed successfully"
                break
              else
                echo "Build failed with conclusion: $CONCLUSION"
                exit 1
              fi
            fi

            echo "Waiting for build to complete... (attempt $i/30)"
            sleep 60
          done
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Download build artifacts
        run: |
          # Download artifacts from the build workflow
          echo "Downloading artifacts from build run: ${{ steps.build_status.outputs.build_run_id }}"

          # ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆä¸€è¦§ã‚’å–å¾—
          ARTIFACTS=$(gh api repos/${{ github.repository }}/actions/runs/${{ steps.build_status.outputs.build_run_id }}/artifacts --jq '.artifacts[]')

          if [ -z "$ARTIFACTS" ]; then
            echo "No artifacts found"
            exit 1
          fi

          echo "Found artifacts:"
          echo "$ARTIFACTS" | jq -r '.name'

          # å„ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
          echo "$ARTIFACTS" | jq -r '"artifact_name=" + .name + " artifact_url=" + .archive_download_url' | while read line; do
            eval $line
            echo "Downloading artifact: $artifact_name"
            gh api "$artifact_url" > "${artifact_name}.zip"
            unzip "${artifact_name}.zip"
            rm "${artifact_name}.zip"
          done

          # ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç¢ºèª
          echo "Downloaded files:"
          ls -la *.zip 2>/dev/null || echo "No archive files found"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.set_tag.outputs.tag_name }}
          name: Release ${{ steps.set_tag.outputs.tag_name }}
          files: |
            *.zip
          draft: false
          prerelease: ${{ steps.set_tag.outputs.prerelease == 'true' }}
          generate_release_notes: true
          body: |
            ## ðŸš€ è‡ªå‹•ãƒ“ãƒ«ãƒ‰ãƒªãƒªãƒ¼ã‚¹ ${{ steps.set_tag.outputs.tag_name }}

            ã“ã®ãƒªãƒªãƒ¼ã‚¹ã¯è‡ªå‹•ãƒ“ãƒ«ãƒ‰ã‚·ã‚¹ãƒ†ãƒ ã«ã‚ˆã£ã¦ç”Ÿæˆã•ã‚Œã¾ã—ãŸã€‚

            ### ðŸ“¥ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰

            - **Windows x86**: `image-coords-app-windows-x86.zip` ðŸ”’ **ã‚³ãƒ¼ãƒ‰ç½²åæ¸ˆã¿**
            - **Windows x64**: `image-coords-app-windows-x64.zip` ðŸ”’ **ã‚³ãƒ¼ãƒ‰ç½²åæ¸ˆã¿**

            ### ðŸ“‹ ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ‰‹é †

            #### Windows
            1. ZIPãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦è§£å‡
            2. `image_coords_app.exe`ã‚’å®Ÿè¡Œ
            3. **åˆå›žå®Ÿè¡Œæ™‚**: Windows Defenderã®è­¦å‘ŠãŒè¡¨ç¤ºã•ã‚Œã‚‹å ´åˆã¯ã€Œè©³ç´°æƒ…å ±ã€â†’ã€Œå®Ÿè¡Œã€ã‚’ã‚¯ãƒªãƒƒã‚¯

            **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã«ã¤ã„ã¦:**
            - âœ… ã‚³ãƒ¼ãƒ‰ç½²åã«ã‚ˆã‚Šã€ã‚¦ã‚¤ãƒ«ã‚¹å¯¾ç­–ã‚½ãƒ•ãƒˆã§ã®èª¤æ¤œçŸ¥ã‚’å¤§å¹…ã«è»½æ¸›
            - âœ… è‡ªå·±ç½²åè¨¼æ˜Žæ›¸ä½¿ç”¨ã®ãŸã‚ã€åˆå›žå®Ÿè¡Œæ™‚ã«è­¦å‘ŠãŒè¡¨ç¤ºã•ã‚Œã‚‹å ´åˆãŒã‚ã‚Šã¾ã™
            - âœ… ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã¯å®‰å…¨ã§ã™

            ### ðŸ†• ä¸»ãªæ©Ÿèƒ½

            - ç”»åƒä¸Šã§ã®åº§æ¨™å…¥åŠ›
            - ä¸è‰¯æ¤œå‡ºãƒã‚¤ãƒ³ãƒˆã®ãƒžãƒ¼ã‚­ãƒ³ã‚°
            - åº§æ¨™ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜ãƒ»èª­ã¿è¾¼ã¿
            - ã‚«ã‚¹ã‚¿ãƒžã‚¤ã‚ºå¯èƒ½ãªè¨­å®š

            è©³ç´°ãªä½¿ç”¨æ–¹æ³•ã¯ [README.md](https://github.com/${{ github.repository }}/blob/main/README.md) ã‚’ã”è¦§ãã ã•ã„ã€‚
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create Release (Alternative using gh CLI)
        if: failure()
        run: |
          echo "Trying alternative release creation method using gh CLI..."

          # ãƒªãƒªãƒ¼ã‚¹ãƒŽãƒ¼ãƒˆã‚’ä½œæˆ
          cat > release_notes.md << 'EOF'
          ## ðŸš€ è‡ªå‹•ãƒ“ãƒ«ãƒ‰ãƒªãƒªãƒ¼ã‚¹ ${{ steps.set_tag.outputs.tag_name }}

          ã“ã®ãƒªãƒªãƒ¼ã‚¹ã¯è‡ªå‹•ãƒ“ãƒ«ãƒ‰ã‚·ã‚¹ãƒ†ãƒ ã«ã‚ˆã£ã¦ç”Ÿæˆã•ã‚Œã¾ã—ãŸã€‚

          ### ðŸ“¥ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰

          - **Windows x86**: `image-coords-app-windows-x86.zip` ðŸ”’ **ã‚³ãƒ¼ãƒ‰ç½²åæ¸ˆã¿**
          - **Windows x64**: `image-coords-app-windows-x64.zip` ðŸ”’ **ã‚³ãƒ¼ãƒ‰ç½²åæ¸ˆã¿**

          ### ðŸ“‹ ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ‰‹é †

          #### Windows
          1. ZIPãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦è§£å‡
          2. `image_coords_app.exe`ã‚’å®Ÿè¡Œ
          3. **åˆå›žå®Ÿè¡Œæ™‚**: Windows Defenderã®è­¦å‘ŠãŒè¡¨ç¤ºã•ã‚Œã‚‹å ´åˆã¯ã€Œè©³ç´°æƒ…å ±ã€â†’ã€Œå®Ÿè¡Œã€ã‚’ã‚¯ãƒªãƒƒã‚¯

          **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã«ã¤ã„ã¦:**
          - âœ… ã‚³ãƒ¼ãƒ‰ç½²åã«ã‚ˆã‚Šã€ã‚¦ã‚¤ãƒ«ã‚¹å¯¾ç­–ã‚½ãƒ•ãƒˆã§ã®èª¤æ¤œçŸ¥ã‚’å¤§å¹…ã«è»½æ¸›
          - âœ… è‡ªå·±ç½²åè¨¼æ˜Žæ›¸ä½¿ç”¨ã®ãŸã‚ã€åˆå›žå®Ÿè¡Œæ™‚ã«è­¦å‘ŠãŒè¡¨ç¤ºã•ã‚Œã‚‹å ´åˆãŒã‚ã‚Šã¾ã™
          - âœ… ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã¯å®‰å…¨ã§ã™

          è©³ç´°ãªä½¿ç”¨æ–¹æ³•ã¯ [README.md](https://github.com/${{ github.repository }}/blob/main/README.md) ã‚’ã”è¦§ãã ã•ã„ã€‚
          EOF

          # gh CLIã§ãƒªãƒªãƒ¼ã‚¹ã‚’ä½œæˆ
          PRERELEASE_FLAG=""
          if [ "${{ steps.set_tag.outputs.prerelease }}" == "true" ]; then
            PRERELEASE_FLAG="--prerelease"
          fi

          gh release create "${{ steps.set_tag.outputs.tag_name }}" \
            --title "Release ${{ steps.set_tag.outputs.tag_name }}" \
            --notes-file release_notes.md \
            $PRERELEASE_FLAG \
            *.zip 2>/dev/null || echo "No archive files to upload"

        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
